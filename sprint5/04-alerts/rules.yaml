---
groups:
- name: service-b.rules
    rules:
    - alert: ServiceBHighErrorRate
      expr: |
        sum(rate(istio_requests_total{destination_service="service-b",response_code=~"5.*"}[5m]))
        /
        sum(rate(istio_requests_total{destination_service="service-b"}[5m])) > 0.01
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: Service B error rate exceeded 1%
        
    - alert: ServiceBHighLatency
      expr: |
        histogram_quantile(0.95, sum(rate(istio_request_duration_milliseconds_bucket{destination_service="service-b"}[5m])) by (le))
        > 
        histogram_quantile(0.95, sum(rate(istio_request_duration_milliseconds_bucket{destination_service="service-b"}[1h] offset 1h)) by (le)) * 1.2
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: Service B P95 latency increased by more than 20% above baseline
        
    - alert: ServiceBDown
      expr: health_up{app="service-b"} == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: Service B health check failed